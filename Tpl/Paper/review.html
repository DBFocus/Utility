<include file="./Tpl/Public/headstart.html" />
<title>考卷总览</title>
<link rel="stylesheet" href="__PUBLIC__/css/common.css" />
<link rel="stylesheet" href="__PUBLIC__/css/paper.css" />
<style>
	.qTitle {
		position: relative;
	}
	
	#editPaperDiv {
		position: absolute;
		top: 10px;
		right: 10px;
	}

	#qTable {
		border-collapse: collapse;
		margin: 20px auto;
	}
	
	#qTable th, #qTable td {
		border: 1px solid gray;
		padding: 2px 5px;
	}
	
	#qTable td {
		text-align: left;
	}
	
	.qName {
		color:black;
	}
	
	#helpMsg {
		position:fixed;
		z-index:2000;
	}
</style>
<script src="http://code.jquery.com/jquery-1.7.2.min.js"></script>
<script src="__PUBLIC__/javascript/paper.js"></script>
<script src="__PUBLIC__/javascript/InputValidate.js"></script>
<script>
	$(function(){
		setSumScoreColor();
		
		setQuestionId();
		
		$('#editPaperBtn').click(function(){
			window.location = "__URL__/edit/p/{$paper.paper_id}"
		});
		
		$('#batchEditScore').click(function(){
			var allOptionScore = $('#allOption').val();
			var allInputScore = $('#allInput').val();
			
			if (allOptionScore != '') {
				if (!validateNumber($('#allOption').get(0), 
								$('#helpMsg').get(0), 
								'请输入有效整数', 
								'', 
								1, 
								{$paper.total_score}, 
								true)){
					promptMsg($('#helpMsg'));
					return;
				}
			}
			
			$('.radio, .checkbox').val(allOptionScore);

			$('.textarea').val(allInputScore);
			//$('.qRow').each(function(){
			//	var qTypeName = $.trim($(this).children('.qType').text());
			//	if (qTypeName == '单选题' || qTypeName == '多选题') {
			//		$(this).find('.qScore').val(allOptionScore);
			//	} else if (qTypeName == '问答题') {
			//		$(this).find('.qScore').val(allInputScore);
			//	}
			//});
		});
		
		$('.qReview').click(function(){	
			window.location = "__APP__/Question/review/p/{$paper.paper_id}/s/" + $(this).parents('tr').find('.qSeq').text();
		});
		
		$('.qRemove').click(function(){
			
		});
		
		$('#qTable').on("change", ".qScore", function(){
			var qScore = $(this).val();
			var pqId = $(this).parents('tr').find('.pqId').text();
			$.post(
				"__URL__/updateScore/",
				{paper_question_id: pqId, question_score: qScore},
				showResponse,
				"json"
			);
		});
		
		$('#browseAllQuestion').click(function(){
			window.location = "__APP__/Question/review/p/{$paper.paper_id}/s/1";
		});
	});
	
	function setQuestionId() {
		var qId = 1;
		$('.qId').each(function(){
			$(this).text(qId++);
		});
	}
	
	function setSumScoreColor() {
		if ($('#sumScore').text() == $('#totalScore').text()) {
			$('#sumScore').css('color', $('#totalScore').css('color'));
		} else {
			$('#sumScore').css('color', 'Orange');
		}
	}	

	function centerAlignLeft(element) {
		var dWidth = $(document).width();
		var eWidth = $(element).width();
		return (dWidth - eWidth)/2;
	}
		
	function promptMsg(msgBox) {
		var box = $(msgBox);
		var left = centerAlignLeft(box);
		box.css('left', left);
		box.slideDown(function() {
						setTimeout(function() { box.slideUp(); }, 
						2000)});
	}
	
	function showResponse(data) {
		var msg = $('#helpMsg');
		msg.html(data.info);
		//var left = centerAlignLeft(msg);
		//msg.css('left', left);
		if (data.status == 0) {			
			promptMsg(msg);
		}
	}
	
</script>	
</head>
<body>	
	<header>
		<table>
			<tr>
				<td>
					共{$question|count}题
				</td>
				<td>
					
				</td>
				<td>
					各题合计<span id="sumScore">{$sumScore}</span>分/考卷<span id="totalScore">{$paper.total_score}</span>分
				</td>
				<td>
					
				</td>
				<td>
					共{$paper.total_mins}分钟
				</td>
			</tr>
		</table>
	</header>

	<section id="content">
	
		<div id="main">
			<div>
				<span id="helpMsg" class="hide"></span>
			</div>

				<div class="qBody">
					<h1 class="qTitle" style="text-align:center">
						{$paper.paper_name}
						<div id="editPaperDiv"><input id="editPaperBtn" type="button" value="编辑" /></div>
					</h1>
					<p class="width-l">
						<strong>注意事项：</strong>{$paper.paper_desc}
					</p>

					<div>
						<span style="margin-right: 20px">选择题:每题 <input type="text" id="allOption" class="width-xs" />分</span>
						<span style="margin-right: 20px">问答题:每题 <input type="text" id="allInput" class="width-xs" />分</span>
						<span style="margin-right: 20px;"><input id="batchEditScore" type="button" value="批量设置" class="width-s" /></span>						
					</div>
				</div>
				<table id="qTable" class="width-xxl">
					<tr>
						<th>序号</th>
						<th>考题</th>
						<th>题型</th>
						<th>分值</th>
						<th></th>
					</tr>
					<volist name="question" id="q">
						<tr class="qRow">
							<td>								
								<span class="qId"></span>
								<span class="pqId hide">{$q.paper_question_id}</span>
								<span class="qSeq hide">{$q.question_seq}</span>
							</td>
							<td>
								<input type="text" value="{$q.question_name}" disabled="disabled" class="width-m qName" />
							</td>
							<td class="qType">
								<if condition="$q.question_type eq 'radio'">
									单选题
								<elseif condition="$q.question_type eq 'checkbox'" />
									多选题
								<elseif condition="$q.question_type eq 'textarea'" />
									问答题
								<else />
									其他
								</if>
							</td>
							<td>
								<input type="input" name="score_{$q.paper_question_id}" value="{$q.question_score}" class="width-xs qScore {$q.question_type}" />
							</td>
							<td>								
								<input type="button" value="查看&编辑" class="qReview" />
								<input type="button" value="移除" class="qRemove" />
								<input type="button" value="插入" />
								<input type="button" value="上移" />
								<input type="button" value="下移" />
							</td>
						</tr>
					</volist>
				</table>
				
				
		</div>
	
	</section>
	<footer>
		<table>
			<tr>
				<td>
					<input id="browseAllQuestion" type="button" value="浏览考题" class="footer-btn" />
				</td>
				<td>
					
				</td>
				<td>
					<input id="saveAndBack" type="button" value="保存&返回" class="footer-btn" />
				</td>
				<td>
					
				</td>
				<td>
					<input id="addNew" type="button" value="添加新题" class="footer-btn" />
				</td>
			</tr>
		</table>
	</footer>

</body>
</html>	
</body>
</html>